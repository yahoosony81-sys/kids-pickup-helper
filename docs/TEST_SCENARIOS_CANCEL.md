# 취소 요청 및 승인 기능 테스트 시나리오

## 테스트 전 준비사항

1. Supabase 마이그레이션 실행:
   ```bash
   # Supabase CLI를 사용하여 마이그레이션 적용
   supabase db push
   ```

2. 개발 서버 실행:
   ```bash
   pnpm dev
   ```

3. 테스트 계정 준비:
   - 요청자 계정 1개
   - 제공자 계정 1개

---

## 테스트 시나리오

### 1. 정상 취소 요청 (출발 2시간 전, REQUESTED 상태)

**목표**: 정상적인 취소 요청 플로우 검증

**절차**:
1. 요청자로 로그인
2. 픽업 요청 생성 (출발 시간: 현재 시간 + 2시간)
3. 요청 상세 페이지 접근 (`/pickup-requests/[requestId]`)
4. "취소 요청" 버튼 클릭
5. 확인 다이얼로그에서 "예, 취소 요청합니다" 클릭

**예상 결과**:
- ✅ 상태가 `CANCEL_REQUESTED`로 변경됨
- ✅ "취소 승인 대기중" 배지 표시
- ✅ `pickup_requests.cancel_requested_at` 필드에 현재 시간 저장
- ✅ `push_notifications` 테이블에 제공자에게 알림 이벤트 생성 (MATCHED 상태인 경우)

**검증 방법**:
- Supabase 대시보드에서 `pickup_requests` 테이블 확인
- `push_notifications` 테이블 확인

---

### 2. 시간 제한 검증 (출발 30분 전)

**목표**: 출발 1시간 이내에는 취소 요청 불가능 검증

**절차**:
1. 요청자로 로그인
2. 픽업 요청 생성 (출발 시간: 현재 시간 + 30분)
3. 요청 상세 페이지 접근
4. 취소 요청 버튼 상태 확인

**예상 결과**:
- ✅ "취소 요청 불가" 버튼 표시 (비활성화)
- ✅ "출발 30분 전입니다. 취소 요청은 출발 1시간 전까지만 가능합니다." 안내 문구 표시
- ✅ 버튼 클릭 불가

**검증 방법**:
- UI에서 버튼 상태 확인
- 서버에서도 동일한 검증 수행 (개발자 도구 Network 탭 확인)

---

### 3. 제공자 취소 승인 (정상 플로우)

**목표**: 제공자가 취소 요청을 승인하고 capacity 복구 검증

**전제 조건**:
- 요청자가 취소 요청을 한 상태 (`CANCEL_REQUESTED`)

**절차**:
1. 제공자로 로그인
2. Trip 상세 페이지 접근 (`/trips/[tripId]`)
3. 참여자 목록에서 `CANCEL_REQUESTED` 상태인 항목 확인
4. "취소 승인" 버튼 클릭
5. 확인 다이얼로그에서 "예, 승인합니다" 클릭

**예상 결과**:
- ✅ `pickup_requests.status`가 `CANCELED`로 변경됨
- ✅ `pickup_requests.cancel_approved_at` 필드에 현재 시간 저장
- ✅ `pickup_requests.cancel_approved_by` 필드에 제공자 profile_id 저장
- ✅ `trip_participants`에서 해당 레코드 삭제됨
- ✅ Trip 상세 페이지에서 capacity가 1 증가 (예: 2/3 → 3/3)
- ✅ `push_notifications` 테이블에 요청자에게 "취소 완료" 알림 이벤트 생성
- ✅ 관련 `invitations` 상태가 `EXPIRED`로 변경됨 (ACCEPTED인 경우)

**검증 방법**:
- Supabase에서 `pickup_requests`, `trip_participants`, `push_notifications` 테이블 확인
- Trip 상세 페이지에서 capacity 표시 확인

---

### 4. 권한 검증 (다른 사용자가 취소 요청 시도)

**목표**: 본인의 요청만 취소할 수 있음 검증

**절차**:
1. 사용자 A로 로그인하여 픽업 요청 생성
2. 사용자 B로 로그인
3. 사용자 A의 요청 상세 페이지 URL 직접 접근 시도
4. 취소 요청 버튼 클릭 시도

**예상 결과**:
- ✅ `getPickupRequestById`에서 "본인의 픽업 요청만 조회할 수 있습니다." 에러 반환
- ✅ 또는 페이지 접근 자체가 차단됨

**검증 방법**:
- 브라우저 개발자 도구 Console/Network 탭에서 에러 확인

---

### 5. 상태 검증 (이미 CANCELED인 요청 취소 시도)

**목표**: 이미 취소된 요청은 다시 취소할 수 없음 검증

**절차**:
1. 요청자로 로그인
2. 이미 `CANCELED` 상태인 픽업 요청 상세 페이지 접근
3. 취소 요청 버튼 표시 여부 확인

**예상 결과**:
- ✅ 취소 요청 버튼이 표시되지 않음
- ✅ 또는 버튼이 비활성화되어 있음

**검증 방법**:
- UI에서 버튼 표시 여부 확인

---

### 6. 동시성 테스트 (두 사용자가 동시에 취소 승인 시도)

**목표**: 동시성 문제 방지 검증

**절차**:
1. 요청자가 취소 요청 (`CANCEL_REQUESTED` 상태)
2. 제공자 A와 제공자 B가 동시에 취소 승인 버튼 클릭
3. (또는 같은 제공자가 두 번 빠르게 클릭)

**예상 결과**:
- ✅ 첫 번째 승인만 성공
- ✅ 두 번째 승인은 "현재 상태에서는 취소 승인을 할 수 없습니다." 에러 반환
- ✅ `pickup_requests.status`는 `CANCELED`로 한 번만 변경됨
- ✅ `trip_participants`는 한 번만 삭제됨

**검증 방법**:
- Supabase에서 `pickup_requests` 테이블의 `updated_at` 확인
- `trip_participants` 테이블에서 레코드 삭제 여부 확인

---

### 7. 푸시 알림 이벤트 생성 검증

**목표**: 취소 요청 시 제공자에게 알림 이벤트가 생성되는지 검증

**절차**:
1. 요청자가 초대를 수락하여 `MATCHED` 상태로 변경
2. 요청자가 취소 요청
3. Supabase에서 `push_notifications` 테이블 확인

**예상 결과**:
- ✅ `push_notifications` 테이블에 레코드 생성
- ✅ `user_profile_id` = 제공자의 profile_id
- ✅ `type` = "cancel_requested"
- ✅ `payload_json`에 `pickup_request_id`, `requester_profile_id`, `message` 포함
- ✅ `processed_at` = null (미처리 상태)

**검증 방법**:
- Supabase 대시보드에서 `push_notifications` 테이블 확인

---

### 8. Capacity 복구 검증

**목표**: 취소 승인 후 제공자의 capacity가 정확히 복구되는지 검증

**전제 조건**:
- Trip에 3명이 참여 중 (capacity: 3/3)
- 한 명이 취소 요청

**절차**:
1. Trip 상세 페이지에서 "수용 인원: 3 / 3" 확인
2. 제공자가 취소 승인
3. 페이지 새로고침 후 "수용 인원: 2 / 3" 확인

**예상 결과**:
- ✅ 취소 승인 전: "수용 인원: 3 / 3"
- ✅ 취소 승인 후: "수용 인원: 2 / 3"
- ✅ `trip_participants` 테이블에서 해당 레코드 삭제됨

**검증 방법**:
- UI에서 capacity 표시 확인
- Supabase에서 `trip_participants` 테이블 확인

---

### 9. MATCHED 상태 취소 요청

**목표**: 초대 수락 후에도 취소 요청이 가능한지 검증

**절차**:
1. 요청자가 픽업 요청 생성 (`REQUESTED` 상태)
2. 제공자가 초대 전송
3. 요청자가 초대 수락 (`MATCHED` 상태)
4. 요청자가 취소 요청 (출발 1시간 전)

**예상 결과**:
- ✅ `MATCHED` 상태에서도 취소 요청 가능
- ✅ 상태가 `CANCEL_REQUESTED`로 변경됨
- ✅ 제공자에게 푸시 알림 이벤트 생성

**검증 방법**:
- UI에서 상태 변경 확인
- `push_notifications` 테이블 확인

---

### 10. IN_PROGRESS 이후 취소 불가 검증

**목표**: 이미 출발한 Trip의 요청은 취소할 수 없음 검증

**절차**:
1. 요청자가 초대 수락 (`MATCHED` 상태)
2. 제공자가 출발 버튼 클릭 (`IN_PROGRESS` 상태)
3. 요청자가 요청 상세 페이지 접근
4. 취소 요청 버튼 표시 여부 확인

**예상 결과**:
- ✅ 취소 요청 버튼이 표시되지 않음
- ✅ 또는 버튼이 비활성화되어 있음
- ✅ 서버에서도 취소 요청 시도 시 "현재 상태에서는 취소 요청을 할 수 없습니다." 에러 반환

**검증 방법**:
- UI에서 버튼 표시 여부 확인
- 직접 API 호출 시도하여 에러 확인

---

## 추가 검증 사항

### 데이터 일관성 검증

1. **트랜잭션 검증**:
   - 취소 승인 시 `pickup_requests`, `trip_participants`, `invitations` 업데이트가 모두 성공하거나 모두 실패하는지 확인

2. **타임스탬프 검증**:
   - `cancel_requested_at`과 `cancel_approved_at`이 올바른 시간대에 저장되는지 확인

3. **FK 무결성 검증**:
   - `cancel_approved_by`가 올바른 `profiles.id`를 참조하는지 확인

---

## 테스트 실행 체크리스트

- [ ] 시나리오 1: 정상 취소 요청
- [ ] 시나리오 2: 시간 제한 검증
- [ ] 시나리오 3: 제공자 취소 승인
- [ ] 시나리오 4: 권한 검증
- [ ] 시나리오 5: 상태 검증
- [ ] 시나리오 6: 동시성 테스트
- [ ] 시나리오 7: 푸시 알림 이벤트 생성
- [ ] 시나리오 8: Capacity 복구
- [ ] 시나리오 9: MATCHED 상태 취소 요청
- [ ] 시나리오 10: IN_PROGRESS 이후 취소 불가

---

## 문제 발생 시 확인 사항

1. **마이그레이션 적용 여부**: Supabase에서 ENUM과 필드가 추가되었는지 확인
2. **서버 로그**: 브라우저 개발자 도구 Console과 서버 로그 확인
3. **데이터베이스 상태**: Supabase 대시보드에서 실제 데이터 확인
4. **캐시 문제**: 브라우저 캐시 삭제 및 `router.refresh()` 호출 확인

